<!doctype html>
<html class="docs-version-current" lang="zh-cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="search" type="application/opensearchdescription+xml" title="Apache YuniKorn (Incubating)" href="/incubator-yunikorn-site/zh-cn/opensearch.xml"><title data-react-helmet="true">调度器缓存删除设计 | Apache YuniKorn (Incubating)</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://yunikorn.apache.org/incubator-yunikorn-site/zh-cn/img/logo/yunikorn-logo-main.png"><meta data-react-helmet="true" name="twitter:image" content="https://yunikorn.apache.org/incubator-yunikorn-site/zh-cn/img/logo/yunikorn-logo-main.png"><meta data-react-helmet="true" property="og:url" content="https://yunikorn.apache.org/incubator-yunikorn-site/zh-cn/docs/next/design/cache_removal"><meta data-react-helmet="true" name="docsearch:language" content="zh-cn"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="调度器缓存删除设计 | Apache YuniKorn (Incubating)"><meta data-react-helmet="true" name="description" content="&lt;!--"><meta data-react-helmet="true" property="og:description" content="&lt;!--"><link data-react-helmet="true" rel="icon" href="/incubator-yunikorn-site/zh-cn/img/yunikorn.ico"><link data-react-helmet="true" rel="canonical" href="https://yunikorn.apache.org/incubator-yunikorn-site/zh-cn/docs/next/design/cache_removal"><link data-react-helmet="true" rel="alternate" href="https://yunikorn.apache.org/incubator-yunikorn-site/docs/next/design/cache_removal" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://yunikorn.apache.org/incubator-yunikorn-site/zh-cn/docs/next/design/cache_removal" hreflang="zh-cn"><link data-react-helmet="true" rel="alternate" href="https://yunikorn.apache.org/incubator-yunikorn-site/docs/next/design/cache_removal" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/incubator-yunikorn-site/zh-cn/assets/css/styles.b5b62de6.css">
<link rel="preload" href="/incubator-yunikorn-site/zh-cn/assets/js/runtime~main.00c90838.js" as="script">
<link rel="preload" href="/incubator-yunikorn-site/zh-cn/assets/js/main.30476b58.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">0.12.1 has been released, check the DOWNLOADS</div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/incubator-yunikorn-site/zh-cn/"><div class="navbar__logo"><img src="/incubator-yunikorn-site/zh-cn/img/logo/yunikorn_blue_logo.png" alt="YuniKorn Site Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/incubator-yunikorn-site/zh-cn/img/logo/yunikorn_white_logo.png" alt="YuniKorn Site Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Apache YuniKorn</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/incubator-yunikorn-site/zh-cn/docs/">快速开始</a><a class="navbar__item navbar__link" href="/incubator-yunikorn-site/zh-cn/community/roadmap">路线图</a><a class="navbar__item navbar__link" href="/incubator-yunikorn-site/zh-cn/community/download">下载</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">社区</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/community/get_involved">进行参与</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/community/how_to_contribute">如何贡献</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/community/coding_guidelines">编码指南</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/community/reporting_issues">报告问题</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/community/events">事件</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Apache</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Apache软件基金会<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Apache孵化项目<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>事件<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>License<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>赞助商<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>赞助<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Security<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/incubator-yunikorn-site/zh-cn/docs">文档</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/incubator-yunikorn-site/zh-cn/docs/next/">Master</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/docs/">0.12.1</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/docs/0.11.0/">0.11.0</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/docs/0.10.0/">0.10.0</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/docs/0.9.0/">0.9.0</a></li><li><a class="dropdown__link" href="/incubator-yunikorn-site/zh-cn/docs/0.8.0/">0.8.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文</span></span></a><ul class="dropdown__menu"><li><a href="/incubator-yunikorn-site/docs/next/design/cache_removal" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/incubator-yunikorn-site/zh-cn/docs/next/design/cache_removal" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文</a></li></ul></div><a href="https://github.com/apache/incubator-yunikorn-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/incubator-yunikorn-site/zh-cn/docs/next/">Get Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/incubator-yunikorn-site/zh-cn/docs/next/user_guide/queue_config">User Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/incubator-yunikorn-site/zh-cn/docs/next/developer_guide/env_setup">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/developer_guide/env_setup">Dev Environment Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/developer_guide/build">Build and Run</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/developer_guide/deployment">Deploy to Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/developer_guide/openshift_development">在 CodeReady 容器中开发</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/architecture">Designs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/architecture">架构</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/scheduler_core_design">Scheduler Core Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/cache_removal">调度器缓存删除设计</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/k8shim">Kubernetes Shim 设计</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/cross_queue_preemption">跨队列抢占</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/namespace_resource_quota">命名空间资源配额</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/pluggable_app_management">Pluggable App Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/resilience">Resilience</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/predicates">Support K8s Predicates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/scheduler_configuration">Scheduler Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/state_aware_scheduling">Batch Workloads Ordering with StateAware Policy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/scheduler_object_states">Scheduler Object States</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/incubator-yunikorn-site/zh-cn/docs/next/design/gang_scheduling">帮派调度设计</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/incubator-yunikorn-site/zh-cn/docs/next/performance/evaluate_perf_function_with_kubemark">Performance</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Apache YuniKorn (Incubating)<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/incubator-yunikorn-site/zh-cn/docs/design/cache_removal">latest version</a></b> (<!-- -->0.12.1<!-- -->).</div></div><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->Next</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>调度器缓存删除设计</h1></header><header><h1>在内核中结合缓存和调度器实现的建议</h1></header><p>本文描述调度器和缓存实现的当前状态。
它描述了基于对当前行为所做的分析而计划的更改。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="目标">目标<a class="hash-link" href="#目标" title="Direct link to heading">​</a></h2><p>本目标是在变更前后提供相同的功能。</p><ul><li>合并前后的单元测试必须全部通过。</li><li>在内核定义的冒烟测试应全部通过并没有重大变化 <sup id="s1"><a href="#f1">定义</a></sup>.</li><li>作为shim代码一部分的端到端测试必须全部通过而不发生更改。</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="背景">背景<a class="hash-link" href="#背景" title="Direct link to heading">​</a></h2><p>当前的调度器核心是围绕用于存储数据的两个主要组件构建的：缓存和调度器对象。
缓存对象构成了要跟踪的大多数数据的基础。
调度器对象跟踪特定于飞行(flight)细节并在缓存对象之上构建。</p><p>两层之间的通信使用一个同步事件，在某些情况下还使用直接更新。
调度器和缓存之间的同步更新确实意味着调度器与缓存之间有一段短时间的“不同步”。
这个短周期可对调度决策产生影响。
其中一个影响被记录在 <a href="https://issues.apache.org/jira/browse/YUNIKORN-169" target="_blank" rel="noopener noreferrer">YUNIKORN-169</a>.</p><p>另外一点是这两种结构给代码带来的复杂性。
在调度器和缓存之间包含一组不同的通信消息。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="调度器和缓存对象之间的一对一映射表明这种区别可能更需要人为控制这种依赖">调度器和缓存对象之间的一对一映射表明，这种区别可能更需要人为控制这种依赖。<a class="hash-link" href="#调度器和缓存对象之间的一对一映射表明这种区别可能更需要人为控制这种依赖" title="Direct link to heading">​</a></h2><b id="f1"></b>定义：冒烟测试的主要变化被定义为，在测试上改变用例和因而改变的变化。由于所做的检查可能依赖于已删除的缓存对象，因此需要进行一些更改。[↩](#s1) ## 结构分析 ### 对象 按照代码分析现有的对象。 调度器和缓存对象之间的重叠部分通过在同一行显示它们来展现。 N/A 表示调度器或缓存中没有等效对象。<table><thead><tr><th>缓存对象</th><th>调度器对象</th></tr></thead><tbody><tr><td>ClusterInfo</td><td>ClusterSchedulingContext</td></tr><tr><td>PartitionInfo</td><td>partitionSchedulingContext</td></tr><tr><td>AllocationInfo</td><td>schedulingAllocation</td></tr><tr><td>N/A</td><td>schedulingAllocationAsk</td></tr><tr><td>N/A</td><td>reservation</td></tr><tr><td>ApplicationInfo</td><td>SchedulingApplication</td></tr><tr><td>applicationState</td><td>N/A</td></tr><tr><td>NodeInfo</td><td>SchedulingNode</td></tr><tr><td>QueueInfo</td><td>SchedulingQueue</td></tr><tr><td>SchedulingObjectState</td><td>N/A</td></tr></tbody></table><p>作为缓存的一部分的 <code>initializer</code> 代码不定义特定的对象。
它含有一个包级别定义的混合体代码和作为 <code>ClusterInfo</code> 对象一部分的代码。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="事件">事件<a class="hash-link" href="#事件" title="Direct link to heading">​</a></h3><p>在内核定义的事件里有多个来源和目标。
某些事件只在缓存和调度器之间的核心里。
这些事件将被删除。</p><table><thead><tr><th>事件</th><th>流程</th><th>建议</th></tr></thead><tbody><tr><td>AllocationProposalBundleEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>RejectedNewApplicationEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>ReleaseAllocationsEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>RemoveRMPartitionsEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>RemovedApplicationEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>SchedulerNodeEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerAllocationUpdatesEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerApplicationsUpdateEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerUpdatePartitionsConfigEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerDeletePartitionsConfigEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>RMApplicationUpdateEvent (add/remove app)</td><td>Cache/Scheduler -&gt; RM</td><td>Modify</td></tr><tr><td>RMRejectedAllocationAskEvent</td><td>Cache/Scheduler -&gt; RM</td><td>Modify</td></tr><tr><td>RemoveRMPartitionsEvent</td><td>RM -&gt; Scheduler</td><td></td></tr><tr><td>RMUpdateRequestEvent</td><td>RM -&gt; Cache</td><td>Modify</td></tr><tr><td>RegisterRMEvent</td><td>RM -&gt; Cache</td><td>Modify</td></tr><tr><td>ConfigUpdateRMEvent</td><td>RM -&gt; Cache</td><td>Modify</td></tr><tr><td>RMNewAllocationsEvent</td><td>Cache -&gt; RM</td><td>Modify</td></tr><tr><td>RMReleaseAllocationEvent</td><td>Cache -&gt; RM</td><td>Modify</td></tr><tr><td>RMNodeUpdateEvent</td><td>Cache -&gt; RM</td><td>Modify</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>移除缓存后，由缓存处理的事件将需要由核心代码处理。
两个事件由缓存和调度器处理。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="详细流程分析">详细流程分析<a class="hash-link" href="#详细流程分析" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="缓存和调度程序中同时存在的对象">缓存和调度程序中同时存在的对象<a class="hash-link" href="#缓存和调度程序中同时存在的对象" title="Direct link to heading">​</a></h3><p>当前的设计基于这样一个事实：缓存对象是所有数据存储的基础。
每个缓存对象必须有一个对应的调度器对象。
核心程序内围绕缓存和调度程序对象的协议很简单。
如果该对象同时存在于调度器和缓存中，则该对象将被添加到缓存中，从而触发相应调度器对象的创建。
删除对象总是以相反的方式处理：首先从调度器中删除，这将触发从缓存中删除的方法。
例如，由 <code>RMUpdateRequestEvent</code> 触发的应用程序的创建将由缓存处理。
Creating a <code>SchedulerApplicationsUpdateEvent</code> to create the corresponding application in the scheduler.
创建 <code>SchedulerApplicationsUpdateEvent</code> 会在调度器中创建相应的应用。</p><p>当添加应用程序和对象状态时，它们也会被添加到缓存对象中。
缓存对象被认为是数据存储，因此也包含了状态。
调度器中没有相应的状态对象。
不可能为同一对象维护两种状态。</p><p>该规则的其他例外是被认为遗失的对象和只有调度器的对象。
<code>schedulingAllocationAsk</code> 跟踪调度器中应用未完成的请求。
<code>reservation</code> 跟踪一个节点对应用和请求组合的临时保留。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="添加删除应用的操作">添加/删除应用的操作<a class="hash-link" href="#添加删除应用的操作" title="Direct link to heading">​</a></h3><p>RM（shim）发送在调度器接口中定义的复合 <code>更新请求</code> 。
此消息由RM代理封装并转发到缓存进行处理。
RM可以请求添加或删除应用。</p><p><strong>应用添加或删除</strong></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RM代理将 cacheevent.RMUpdateRequestEvent 发送到缓存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processApplicationUpdateFromRMUpdate</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: 将新应用添加到分区。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: 将删除的应用发送到调度器（但不从缓存中删除任何内容）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processApplicationUpdateEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 将新应用添加到调度器</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        (当失败时候, 发送 RejectedNewApplicationEvent 到缓存)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        无论是否失败，都将R MApplicationUpdateEvent 发送到 RM。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: 从调度器删除应用</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        发送 RemovedApplicationEvent 到缓存</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="删除应用和添加或删除请求的操作">删除应用和添加或删除请求的操作<a class="hash-link" href="#删除应用和添加或删除请求的操作" title="Direct link to heading">​</a></h3><p>RM（shim）发送在调度器接口中定义的复合 <code>更新请求</code> 。
此消息由RM代理封装并转发到缓存进行处理。
RM可以请求删除应用。
RM可以请求添加或删除请求。</p><p><strong>资源分配删除</strong>
如下描述了仅由 RM 发起的资源分配删除</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy 将 cacheevent.RMUpdateRequestEvent 发送到缓存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewAndReleaseAllocationRequests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: (分支): 通过事件 ScheduleLocationUpdateEvent 发送到调度器</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationUpdateEvent </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 更新 ReconcilePlugin（协调插件）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: 通过事件 ReleaseAllocationsEvent 将释放确认发送回缓存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4. cluster_info.processAllocationReleases 处理已确认的发布</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>资源申请（ask）添加</strong>
如果资源申请已存在，此添加将自动转换为一个更新。</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy 发送 cacheevent.RMUpdateRequestEvent 到缓存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewAndReleaseAllocationRequests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: 资源申请健全性检查（如分区/应用程序的存在），拒绝信息会通过 RMRejectedAllocationAskEvent 发送回 RM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: 通过 ScheduleLocationUpdateEvent 将选中的资源申请传递给调度器</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationUpdateEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 使用新的或更新的资源申请更新调度程序。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: 通过 RMRejectedAllocationAskEvent 将拒绝信息发送回 RM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.3: 接受的资源申请未确认到 RM 或缓存</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>资源申请删除</strong></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy 将 cacheevent.RMUpdateRequestEvent 发送到缓存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewAndReleaseAllocationRequests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: (分支): 通过事件 ScheduleLocationUpdateEvent 发送到调度器</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationReleaseByAllocationKey</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 更新调度应用程序并删除资源申请。</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="添加更新或删除节点的操作">添加、更新或删除节点的操作<a class="hash-link" href="#添加更新或删除节点的操作" title="Direct link to heading">​</a></h3><p>RM（shim）发送一个在调度器接口中定义好的复杂 <code>UpdateRequest</code> 。
此消息由 RM 代理包装并转发到缓存进行处理。
RM 可以请求添加、更新或删除节点。</p><p><strong>节点添加</strong> </p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy 发送 cacheevent.RMUpdateRequestEvent 到缓存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewSchedulableNodes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: 节点健全性检查（如分区/节点的存在）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: 向分区添加新的节点。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: 通过 SchedulerNodeEvent 通知调度器新节点</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. 通过 RMNodeUpdateEvent 通知 RM 节点添加和拒绝</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 通过 ScheduleLocationUpdateEvent 通知调度器要恢复的资源分配</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4. scheduler.processAllocationUpdateEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   4.1: 调度器根据要恢复的资源分配创建新的资源申请 </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   4.2: 使用特殊的处理来恢复新节点上的资源分配</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   4.3: 确认调度器中的资源分配，失败时使用 ReleaseAllocationsEvent 更新缓存</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>节点更新和移除</strong></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy 发送 cacheevent.RMUpdateRequestEvent 到缓存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNodeActions</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: 节点健全性检查（如分区/节点的存在）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: 节点信息更新 (资源改变)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        2.2.1: 在缓存更新节点</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        2.2.2: 通过 via SchedulerNodeEvent 通知调度器节点的更新</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: 节点状态更新 (非产出), 只在缓存中更新节点状态</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.4: 节点移除</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        2.4.1: 从缓存中更新节点的状态然后移除节点</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        2.4.2: 删除资源分配并通过 RMReleaseAllocationEvent 通知 RM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        2.4.3: 通过 SchedulerNodeEvent 通知调度器节点的移除</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processNodeEvent 新增/移除/更新节点</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="添加更新或删除分区的操作">添加、更新或删除分区的操作<a class="hash-link" href="#添加更新或删除分区的操作" title="Direct link to heading">​</a></h3><p><strong>添加 RM</strong></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy 发送 commonevents.RemoveRMPartitionsEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   如果 RM 已经被注册</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   1.1: scheduler.removePartitionsBelongToRM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        1.1.1: 调度器清理</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        1.1.2: 调度器发送 commonevents.RemoveRMPartitionsEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   1.2: cluster_info.processRemoveRMPartitionsEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        1.2.1: 缓存清理</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. RMProxy 发送 commonevents.RegisterRMEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. cluster_info.processRMRegistrationEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: 缓存相应地更新内部分区/队列。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: 缓存发送 ScheduleUpdatePartitionsConfigEvent 到调度器。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processUpdatePartitionConfigsEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 调度器相应地更新分区/队列信息。</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>更新和移除分区</strong>
基于配置文件更新触发。</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy 发送 commonevents.ConfigUpdateRMEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processRMConfigUpdateEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: 缓存相应地更新内部分区/队列。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: 缓存发送 ScheduleUpdatePartitionsConfigEvent 到调度器。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: 缓存标记要删除的分区（尚未删除）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.4: 缓存发送 SchedulerDeletePartitionsConfigEvent 到调度器。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processUpdatePartitionConfigsEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 调度器相应地更新分区/队列信息。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4. scheduler.processDeletePartitionConfigsEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   4.1: 调度器设置 partitionManager.stop = true.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   4.2: PartitionManager 异步删除队列、应用程序和节点。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        这是“真正的清理“，包括缓存。</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="资源分配">资源分配<a class="hash-link" href="#资源分配" title="Direct link to heading">​</a></h3><p>资源分配由调度器进程启动。
调度器在调度器端创建 SchedulingAllocation ，然后将其封装在 AllocationProposal 中。
调度器已经检查了资源等，并将资源分配标记为正在进行中。
此描述在资源分配将被确认和最终确定时开始</p><p><strong>新的分配</strong></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. 调度程序将 SchedulingAllocation 封装在 AllocationProposalBundleEvent 中。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processAllocationProposalEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   抢占案例：释放被抢占的资源分配</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: 释放缓存中的资源分配</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: 通过 SchedulerNodeEvent 通知调度器资源分配已经被释放</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: 通过 RRMReleaseAllocationEvent 通知 RM 资源分配已经被释放</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   所有情况：添加新的资源分配</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.4: 向缓存中添加新的资源分配</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.5: 通过 SchedulerAllocationUpdatesEvent 将拒绝信息发送回调度器 </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.6: 通过 SchedulerAllocationUpdatesEvent 通知调度器资源分配已经被添加</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   2.7: 通过 RMNewAllocationsEvent 通知 RM 资源分配已经被添加</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationUpdateEvent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: 确认信息被添加到调度器并从运行中更改为确认。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        在处理失败时，一个 ReleaseAllocationsEvent 被 *再次* 发送到缓存中进行清理。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        这是 [YUNIKORN-169] 问题中的一部分</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        cluster_info.processAllocationReleases</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: 拒绝处理会从调度器中删除进行中的资源分配。 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="当前的锁机制">当前的锁机制<a class="hash-link" href="#当前的锁机制" title="Direct link to heading">​</a></h2><p><strong>集群锁:</strong><br>
<!-- -->一个集群包含一个或多个分区对象。一个分区是集群的一个子对象。
添加或删除“任何”分区需要集群的写锁。
检索集群内的任何对象都需要迭代分区列表，从而需要对集群进行读锁。</p><p><strong>分区锁:</strong><br>
<!-- -->分区对象包含到队列、应用程序或节点对象的所有链接。
添加或删除“任何”队列、应用程序或节点需要分区的写锁。
检索分区内的任何对象都需要分区的读锁以防止数据竞争。</p><p>需要写锁的操作示例</p><ul><li>调度后的资源分配处理，将改变应用程序、队列和节点对象。
由于预留可能的更新，因此需要分区锁定。</li><li>节点资源的更新
它不仅会影响节点的可用资源，还会影响分区的总可分配资源 </li></ul><p>需要读锁的操作示例：</p><ul><li>检索任何队列、应用程序或节点都需要读锁
对象本身没有作为检索的一部分被锁定</li><li>在缓存中处理后确认分配
该分区仅被锁定以供读取，以允许检索将被更改的对象
更改是在底层对象上进行的</li></ul><p>不需要任何锁的操作示例：</p><ul><li>调度中<br>在需要时锁定特定对象，在确认分配之前不会直接更新分区。</li></ul><p><strong>队列锁:</strong><br>
<!-- -->队列可以跟踪应用程序（叶类型）或其他队列（父类型）。
资源可以以相同的方式被两种类型所跟踪。</p><p>添加或删除应用程序（叶类型）或一个直接的子队列（父类型）需要队列的写锁定。
更新追踪的资源需要一个写锁定。<br>
<!-- -->更改以递归方式进行，一次不会锁定超过1个队列。
更新队列上的任何配置属性都需要一个写锁。
检索任何配置值，或跟踪的资源、应用程序或队列都需要读锁。</p><p>需要写锁的操作示例</p><ul><li>将应用程序添加到叶队列</li><li>更新预留资源</li></ul><p>需要读锁的操作示例</p><ul><li>从叶类型队列中检索应用程序</li><li>检索挂起的资源</li></ul><p><strong>应用程序锁:</strong><br>
<!-- -->应用程序跟踪不同类型的资源、分配和未完成的申请。
更新任何跟踪的资源、分配或申请都需要写锁。
检索这些值中的任何一个都需要一个读锁。</p><p>调度期间还需要应用程序的写锁。
在调度期间，为应用程序保留写锁。
将在需要访问或更新的节点或队列上进行锁定。
其他对象上的锁的例子是：</p><ul><li>用于访问队列跟踪资源的读锁</li><li>用于更新节点上正在进行资源分配的写锁</li></ul><p>需要写锁的操作示例</p><ul><li>新增一个资源申请</li><li>尝试调度待处理的申请</li></ul><p>需要读锁的操作示例</p><ul><li>检索分配的资源</li><li>检索待处理的申请</li></ul><p><strong>节点锁:</strong><br>
<!-- -->节点跟踪不同类型和分配的资源。
更新任何跟踪的资源或资源分配需要写锁。
检索这些值中的任何一个都需要一个读锁。</p><p>在分配阶段运行的检查根据需要获取锁。
更新时检查写锁时的读锁。
一个节点在整个分配周期内没有被锁定。</p><p>需要写锁的操作示例</p><ul><li>添加新的资源分配</li><li>更新节点资源</li></ul><p>需要读锁的操作示例</p><ul><li>检索分配的资源</li><li>检索资源预留的状态</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="如何合并缓存和调度器对象">如何合并缓存和调度器对象<a class="hash-link" href="#如何合并缓存和调度器对象" title="Direct link to heading">​</a></h2><p>由于不再需要区分缓存和调度器中的对象，因此 <code>调度</code> 和 <code>信息</code> 部分的名称将被删除。</p><p>主体的调整和合并概述：</p><ol><li><code>application_info</code> 和 <code>scheduling_application</code>: <strong>合并</strong> 到 <code>scheduler.object.application</code></li><li><code>allocation_info</code> 和 <code>scheduling_allocation</code>: <strong>合并</strong> 到 <code>scheduler.object.allocation</code></li><li><code>node_info</code> 和 <code>scheduling_node</code>: <strong>合并</strong> 到 <code>scheduler.object.node</code></li><li><code>queue_info</code> 和 <code>scheduling_queue</code>: <strong>合并</strong> 到 <code>scheduler.object.queue</code></li><li><code>partition_info</code> 和 <code>scheduling_partition</code>: <strong>合并</strong> 到 <code>scheduler.PartitionContext</code></li><li><code>cluster_info</code> 和 <code>scheduling_context</code>: <strong>合并</strong> 到 <code>scheduler.ClusterContext</code></li><li><code>application_state</code>: <strong>移动</strong> 到 <code>scheduler.object.applicationState</code></li><li><code>object_state</code>: <strong>移动</strong> 到 <code>scheduler.object.objectState</code></li><li><code>initializer</code>: <strong>移动</strong> 入 <code>scheduler.ClusterContext</code></li></ol><p>代码的这种调整和合并包括将对象重构到它们自己的包中。
因此，这只会影响已经定义的两个调度器对象，预留和调度申请。
两者都将被移动到对象包中。</p><p>顶层调度器的包路径会保留用于上下文和调度代码。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="代码合并">代码合并<a class="hash-link" href="#代码合并" title="Direct link to heading">​</a></h2><p>第一个变化是事件处理。
所有 RM 事件现在将直接在调度器中处理。
事件处理将发生重大变化，而不仅仅是简单的合并。
合并后将只剩下 RM 生成的事件。
正如上面分析中所描述的，几乎在所有情况下，调度器都会收到来自 RM 事件的更改通知。</p><p>从广义上讲，事件删除触发的更改类型只有三种：</p><ul><li>配置更改：需要新的调度器代码，因为缓存处理不能转移到调度器</li><li>节点、资源申请和应用程序更改：将缓存代码合并到调度程序中</li><li>分配更改：取消确认周期并简化调度程序代码</li></ul><p>配置更改的处理是事件处理的一部分。
所有配置更改现在将直接更新调度程序对象。
调度程序的工作方式与缓存略有不同，这意味着代码不可传输。</p><p>节点和应用程序实际上在缓存和调度器间被拆分。
在缓存对象中跟踪的而在调度器对象中没有等效值的对象都将移动到调度器对象中。
所有对调度器对象的引用都将被删除。
通过代码合并直接调用缓存对象的现有调度器代码将返回调度器对象中新的跟踪值。
这些调用因此将成为调度器中的锁定调用。</p><p>运行中的资源分配的概念将被删除。
分配将在相同的调度迭代中以没有事件或提案创建的方式进行。
移除了跟踪在调度器对象上的分配资源的必要性。
需要对进行中的资源进行跟踪，以确保在做出调度决策时将考虑未由缓存确认的分配。</p><p>应用程序和对象状态将是调度器对象的一个集成部分。
因此，状态更改是即时的，这应该可以防止发生 <a href="https://issues.apache.org/jira/browse/YUNIKORN-169" target="_blank" rel="noopener noreferrer">YUNIKORN-169</a> 之类的问题。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="合并后锁定">合并后锁定<a class="hash-link" href="#合并后锁定" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="锁定方向">锁定方向<a class="hash-link" href="#锁定方向" title="Direct link to heading">​</a></h3><p>在持有锁的同时获取另一个锁是可能的，但我们需要确保我们不允许：</p><ul><li>持有 A.lock 并获取 B 的锁。</li><li>持有 B.lock 并获取 B 的锁。 </li></ul><p>调度器中的当前代码尽可能晚地锁定，并且仅在所需的时间段内锁定。
由于每个对象都有自己的锁，因此一些操作不会在调度程序端锁定，而只是在缓存端锁定。
这意味着从缓存中读取值不会锁定调度对象。</p><p>通过将缓存集成到调度器中，锁的数量将随着对象数量的减少而减少。
每个等价的对象、缓存和调度器，过去都有自己的锁，现在只有一个。
执行代码合并后，将留下一个锁。
随着调度器对象中字段数量的增加，锁定将更频繁地发生。</p><p>在合并之前未锁定调度器对象的调用将被锁定。
锁争用可能会导致性能下降。
对象和事件处理中减少的开销有望弥补这一点。
要跟踪的一点是锁定行为的变化。
当代码简单地合并而不查看顺序时，新行为可能会导致新的死锁情况。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="缓解死锁">缓解死锁<a class="hash-link" href="#缓解死锁" title="Direct link to heading">​</a></h3><p>调度器内部的锁定将保持原样。
这意味着主调度逻辑将根据需要获取和释放对象上的锁。
在应用程序被锁定以对其进行调度之前，不会长期持有读锁或写锁。</p><p>需要注意的一个主要问题是在持有锁时不应执行对象的迭代。
例如，在迭代队列应用程序的调度期间，我们不应该锁定队列。</p><p>另一个例子是分区中的事件处理不应锁定不需要的分区。
例如，在检索需要更新的节点时应锁定分区，并在尝试锁定节点本身之前释放锁定。</p><p>这种方法适合当前的锁定方法，并将锁定更改保持在最低限度。
测试，特别是端到端测试，应该捕捉这些死锁。
没有已知的工具可用于检测或描述锁定顺序。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/incubator-yunikorn-site/zh-cn/docs/next/design/scheduler_core_design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Scheduler Core Design</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/incubator-yunikorn-site/zh-cn/docs/next/design/k8shim"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kubernetes Shim 设计</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#目标" class="table-of-contents__link toc-highlight">目标</a></li><li><a href="#背景" class="table-of-contents__link toc-highlight">背景</a></li><li><a href="#调度器和缓存对象之间的一对一映射表明这种区别可能更需要人为控制这种依赖" class="table-of-contents__link toc-highlight">调度器和缓存对象之间的一对一映射表明，这种区别可能更需要人为控制这种依赖。</a><ul><li><a href="#事件" class="table-of-contents__link toc-highlight">事件</a></li></ul></li><li><a href="#详细流程分析" class="table-of-contents__link toc-highlight">详细流程分析</a><ul><li><a href="#缓存和调度程序中同时存在的对象" class="table-of-contents__link toc-highlight">缓存和调度程序中同时存在的对象</a></li><li><a href="#添加删除应用的操作" class="table-of-contents__link toc-highlight">添加/删除应用的操作</a></li><li><a href="#删除应用和添加或删除请求的操作" class="table-of-contents__link toc-highlight">删除应用和添加或删除请求的操作</a></li><li><a href="#添加更新或删除节点的操作" class="table-of-contents__link toc-highlight">添加、更新或删除节点的操作</a></li><li><a href="#添加更新或删除分区的操作" class="table-of-contents__link toc-highlight">添加、更新或删除分区的操作</a></li><li><a href="#资源分配" class="table-of-contents__link toc-highlight">资源分配</a></li></ul></li><li><a href="#当前的锁机制" class="table-of-contents__link toc-highlight">当前的锁机制</a></li><li><a href="#如何合并缓存和调度器对象" class="table-of-contents__link toc-highlight">如何合并缓存和调度器对象</a></li><li><a href="#代码合并" class="table-of-contents__link toc-highlight">代码合并</a></li><li><a href="#合并后锁定" class="table-of-contents__link toc-highlight">合并后锁定</a><ul><li><a href="#锁定方向" class="table-of-contents__link toc-highlight">锁定方向</a></li><li><a href="#缓解死锁" class="table-of-contents__link toc-highlight">缓解死锁</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">博客</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.cloudera.com/yunikorn-a-universal-resources-scheduler/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>What&#x27;s YuniKorn?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.cloudera.com/apache-yunikorn-incubating-0-8-release-whats-new-and-upcoming/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>What&#x27;s new in YuniKorn 0.8.0?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Github</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-core/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>scheduler-core<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-k8shim" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>kubernetes-shim<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-scheduler-interface" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>scheduler-interface<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-web" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>scheduler-web<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/incubator-yunikorn-site/zh-cn/community/get_involved">参与</a></li><li class="footer__item"><a href="https://people.apache.org/phonebook.html?podling=yunikorn" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>名册<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://issues.apache.org/jira/projects/YUNIKORN/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="https://incubator.apache.org/images/incubator_feather_egg_logo.png" alt="Apache Incubator Logo" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="https://incubator.apache.org/images/incubator_feather_egg_logo.png" alt="Apache Incubator Logo" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">
<div style="font-size: 70%">
Copyright © 2020-2022 <a href="https://www.apache.org/">The Apache Software Foundation</a>. Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. <br>
<div style="padding:20px; margin: 10px; color: #4d4d4d;">
<p>Apache YuniKorn is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>

<p>The Apache Software Foundation Apache YuniKorn, YuniKorn, Apache, the Apache feather, and the Apache YuniKorn project logo are either registered trademarks or trademarks of the Apache Software Foundation.  Apache YuniKorn is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the name of Apache TLP sponsor.</p>
</div>
</div></div></div></div></footer></div>
<script src="/incubator-yunikorn-site/zh-cn/assets/js/runtime~main.00c90838.js"></script>
<script src="/incubator-yunikorn-site/zh-cn/assets/js/main.30476b58.js"></script>
</body>
</html>